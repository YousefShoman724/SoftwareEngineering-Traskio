<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }

    h2 {
      color: #2f3640;
    }

    .logout-btn {
      background: #e84118;
      color: #fff;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      float: right;
    }

    .logout-btn:hover { opacity: 0.9; }

    .form-box {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .form-box input, .form-box select, .form-box button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .form-box button {
      background: #273c75;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    .form-box button:hover { opacity: 0.9; }

    .task-card {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .task-card b {
      font-size: 16px;
      color: #192a56;
    }

    .task-card input, .task-card select {
      width: 95%;
      padding: 5px;
      margin: 3px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .task-card button {
      margin-top: 5px;
      margin-right: 5px;
      background: #44bd32;
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
    }

    .task-card button:hover { opacity: 0.9; }

    .task-card .delete-btn {
      background: #e84118;
    }

    .task-card .edit-btn {
      background: #40739e;
    }

    .task-card .cancel-btn {
      background: #718093;
    }

    .task-actions {
      margin-top: 5px;
    }

    /* Search & Filter box */
    .filter-box {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .filter-box input, .filter-box select {
      flex: 1;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .filter-box button {
      background: #273c75;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }

    .filter-box button:hover { opacity: 0.9; }
  </style>
</head>
<body>

<h2>Dashboard</h2>
<button class="logout-btn" onclick="logout()">Logout</button>

<div class="form-box">
  <input id="title" placeholder="Task title">
  <input id="desc" placeholder="Description">
  <input id="assigned_to" placeholder="Assign To (email)">
  <select id="status">
    <option value="Pending">Pending</option>
    <option value="In Progress">In Progress</option>
    <option value="Completed">Completed</option>
  </select>
  <button onclick="addTask()">Add Task</button>
</div>

<!-- Search & Filter -->
<div class="filter-box">
  <input id="search" placeholder="Search by title or description">
  <select id="filter-status">
    <option value="">All Status</option>
    <option value="Pending">Pending</option>
    <option value="In Progress">In Progress</option>
    <option value="Completed">Completed</option>
  </select>
  <button onclick="applyFilter()">Apply</button>
</div>

<div id="tasks"></div>

<script>
let allTasks = []; // حفظ كل المهام

async function loadTasks(){
  let r = await fetch("/tasks");
  allTasks = await r.json();
  displayTasks(allTasks);
}

function displayTasks(tasks){
  const container = document.getElementById("tasks");
  container.innerHTML = "";

  // Sort by ID ascending
  tasks.sort((a,b)=>a.id-b.id);

  tasks.forEach(x=>{
    // Assign color based on status
    let statusColor;
    if(x.status === "Pending") statusColor = "#fbc531"; 
    else if(x.status === "In Progress") statusColor = "#00a8ff"; 
    else if(x.status === "Completed") statusColor = "#44bd32"; 

    container.innerHTML += `
      <div class="task-card" id="task-${x.id}">
        <b>Title:</b> <input value="${x.title}" id="title-${x.id}" disabled><br>
        <b>Description:</b> <input value="${x.description}" id="desc-${x.id}" disabled><br>
        <b>Assign To:</b> <input value="${x.assigned_to}" id="assign-${x.id}" disabled><br>
        <b>Status:</b>
        <select id="status-${x.id}" disabled style="background:${statusColor};color:#fff;">
          <option value="Pending" ${x.status==="Pending"?"selected":""}>Pending</option>
          <option value="In Progress" ${x.status==="In Progress"?"selected":""}>In Progress</option>
          <option value="Completed" ${x.status==="Completed"?"selected":""}>Completed</option>
        </select>
        <div class="task-actions">
          <button class="edit-btn" onclick="editTask(${x.id})">Edit</button>
          <button class="cancel-btn" onclick="cancelEdit(${x.id})" style="display:none;">Cancel</button>
          <button class="delete-btn" onclick="deleteTask(${x.id})">Delete</button>
          <button class="update-btn" onclick="updateTask(${x.id})" style="display:none;">Update</button>
        </div>
      </div>
    `;
  });
}

function applyFilter(){
  const searchVal = document.getElementById("search").value.toLowerCase();
  const statusVal = document.getElementById("filter-status").value;

  const filtered = allTasks.filter(task=>{
    const matchesSearch = task.title.toLowerCase().includes(searchVal) || task.description.toLowerCase().includes(searchVal);
    const matchesStatus = statusVal ? task.status === statusVal : true;
    return matchesSearch && matchesStatus;
  });

  displayTasks(filtered);
}

async function addTask(){
  let title = document.getElementById("title").value;
  let desc = document.getElementById("desc").value;
  let assigned_to = document.getElementById("assigned_to").value;
  let status = document.getElementById("status").value;

  if(!title) return alert("Title required");

  await fetch("/tasks",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({title, description:desc, assigned_to, status})
  });

  document.getElementById("title").value="";
  document.getElementById("desc").value="";
  document.getElementById("assigned_to").value="";
  document.getElementById("status").value="Pending";

  loadTasks();
}

function editTask(id){
  document.getElementById(`title-${id}`).disabled = false;
  document.getElementById(`desc-${id}`).disabled = false;
  document.getElementById(`assign-${id}`).disabled = false;
  document.getElementById(`status-${id}`).disabled = false;

  document.querySelector(`#task-${id} .edit-btn`).style.display="none";
  document.querySelector(`#task-${id} .cancel-btn`).style.display="inline-block";
  document.querySelector(`#task-${id} .update-btn`).style.display="inline-block";
}

function cancelEdit(id){
  loadTasks();
}

async function updateTask(id){
  let title = document.getElementById(`title-${id}`).value;
  let desc = document.getElementById(`desc-${id}`).value;
  let assigned_to = document.getElementById(`assign-${id}`).value;
  let status = document.getElementById(`status-${id}`).value;

  await fetch(`/tasks/${id}`,{
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({title, description:desc, assigned_to, status})
  });

  loadTasks();
}

async function deleteTask(id){
  await fetch(`/tasks/${id}`,{
    method:"DELETE"
  });
  loadTasks();
}

async function logout(){
  await fetch("/logout");
  location="/";
}

// Initial load
loadTasks();
</script>

</body>
</html>
